<!DOCTYPE HTML>
<html style="margin:10px">
    <head>
        <link rel="stylesheet" type="text/css" href="../public/bootstrap.css">
        <link rel="stylesheet" type="text/css" href="../public/app.css">

        <!-- The following 'include' lets us play midi files from the browser 
        Note: the <% // stuff %> is part of the ejs template. the angle bracket 
        and percent sign will be read throughout the entire page, even in comments -->

        <% include ../js/includes.js %>


        <!-- Our own Javascript goes here! -->
        <script> 

        var octave = 4; 

        document.onkeydown = function(event){
		    var key_press = String.fromCharCode(event.keyCode)
		    var key_code = event.keyCode 

		    var notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B']; 
		    var keyPresses = ['A', 'S', 'D', 'F', 'G', 'H', 'J'];

		    var index = keyPresses.indexOf(key_press);
 
		    if (index !== -1)
		    {
		    	playNote(notes[index]); 
		    }
		    
		};

		// Plays a midi file 
        function playFile() {

        	var element = document.getElementById('instrument');

        	var instrument = element.options[element.selectedIndex].value; 

        	var lookup = {'alto_sax': 65, 'acoustic_grand_piano': 0, 'choir_aahs': 52};
        
            MIDI.loadPlugin({
            soundfontUrl: "./soundfont/",
            instrument: instrument,
            callback: function() {
        		MIDI.programChange(0, lookup[instrument]);
                MIDI.Player.loadFile('./mid/test.mid', MIDI.Player.start); 
               }
        	});
    	}

    	// Plays a note from mp3 library
        function playNote(note)
        {

        	var audio = new Audio(); 
        	audio.src = './mp3/' + note + octave + '.mp3'; 
        	audio.play(); 
        	/* 
			The following code can be used to dynamically generate the mp3's (as midi's), 
			but it is terribly slow. There is a significant delay between pressing 
			the button and hearing the piano sound. 

        	console.log(MIDI.keyToNote); 
        	note = MIDI.keyToNote[note]; 

	        MIDI.loadPlugin({
			soundfontUrl: "./soundfont/",
			instrument: "acoustic_grand_piano",
			callback: function() {
				var delay = 0; // play one note every quarter second
				var velocity = 127; // how hard the note hits
				// play the note
				MIDI.setVolume(0, 127);
				MIDI.noteOn(0, note, velocity, delay);
				MIDI.noteOff(0, note, delay + 0.75);
				}
			});
			*/
		}
		
		function changeOctave()
		{
    		var e = document.getElementById('octave_selector');
	  		octave = e.options[e.selectedIndex].value;
		}
		

        </script>
    </head>

    <body>
    	<div id = "content">
	    <p id = "status"> Keyboard for Playback Only</p>

	   	<div> 
	    	<label id="select_octave"> Select an Octave:</label>
		    <select class = "dropdown" id = "octave_selector" onchange="changeOctave();">
				<option value="3">3</option>
				<option value="4">4</option>
				<option value="5">5</option>
				<option value="6">6</option>
			</select>
		</div>


	    <nav id = "keyboard">
	        <% 
	        var notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B']; 

	        for (var i = 0; i < notes.length; i++)
	          { 
	        %>
	          <button class="btn btn-default navbar-btn" onclick = "playNote('<%=notes[i]%>')"> <%= notes[i] %> </button>
	        <% } %>
	    </nav>  

	    <p> <b> Keyboard Input: </b>keys A,S,D,F,G,H,J </p> 

	    <h1> Javascript Midi Player </h1> 

	    <p> <b> Instructions: </b> Enter a melody in the text box below in the format and press the green Generate Midi button. Then, use the following to select an instrument and Play! </p> 
	    <div id="instrument_selector"> 
	    	<label id="select_instrument"> Select Instrument:</label>
		    <select class = "dropdown" id = 'instrument'>
		    	<option value="alto_sax">Antuan's Sax</option>
				<option value="acoustic_grand_piano"> Andrew's Piano </option>
				<option value="choir_aahs"> Evan's Voice </option>
			</select>
		</div>

		<a class="btn btn-primary" type = "button" onclick="javascript:void(playFile())"> Play! </a>

		<br/>

		<img src="../public/eighth_note.png" height = "45px"/> = 64 
		<img src="../public/quarter_note.png"  height = "50px"/> = 128 
		<img src="../public/half_note.png" height="50px" /> = 256

		<p id="input" > <b>Input Format:</b> noteOctave,duration noteOctave,duration ... </p>
	    <form method="post" action="generate">
	        <input 	type="text" 
	        		size = "30"
	        		style = "margin: 15px"
	             	name="pattern"
	             	placeholder="Enter a string of Notes here, separated by commas"
                    value = "c4,128 c4,128, g4,128 g4,128 a4,128 a4,128 g4,128"
	                         />
	        </input> <br/>
	        <button class = "btn btn-success" type="submit"> 
	        	Generate Midi
	        </button>
	    </form>

	    <form method = "get" action="download">
    		<button  class="btn btn-danger" type="submit" value="This is a button link"> Download </button>
		</form>
		</div> 
 	</body>
</html>
